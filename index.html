<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Campus Event Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="p-4">

<h1>Campus Event Management</h1>

<!-- Student Registration -->
<div class="mb-3">
  <label>Student ID:</label>
  <input type="number" id="attStudentId">
  <button class="btn btn-warning" onclick="loadRegisteredEvents()">Load My Registered Events</button>
</div>

<!-- Registered Events Table -->
<table class="table table-bordered" id="attendanceTable">
  <thead>
    <tr>
      <th>Event ID</th>
      <th>Name</th>
      <th>Date</th>
      <th>Mark Attendance</th>
      <th>Submit Feedback</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const backendURL = 'http://localhost:3000';

// Load Registered Events
async function loadRegisteredEvents() {
  const studentId = document.getElementById('attStudentId').value;
  if (!studentId) { alert('Enter Student ID'); return; }

  const res = await fetch(`${backendURL}/my-registrations/${studentId}`);
  const data = await res.json();

  const tbody = document.querySelector('#attendanceTable tbody');
  tbody.innerHTML = '';

  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5">No registrations found</td></tr>';
    return;
  }

  data.forEach(event => {
    tbody.innerHTML += `<tr>
      <td>${event.event_id}</td>
      <td>${event.name}</td>
      <td>${event.date}</td>
      <td><button class="btn btn-success btn-sm" onclick="markAttendance(${studentId}, ${event.event_id})">Present</button></td>
      <td>
        <select id="rating-${event.event_id}">
          <option value="">Rate</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
        <button class="btn btn-info btn-sm" onclick="submitFeedback(${studentId}, ${event.event_id})">Submit</button>
      </td>
    </tr>`;
  });
}

// Mark Attendance
async function markAttendance(studentId, eventId) {
  await fetch(`${backendURL}/attendance`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ student_id: studentId, event_id: eventId, status: 'present' })
  });
  alert('Attendance marked!');
}

// Submit Feedback
async function submitFeedback(studentId, eventId) {
  const rating = document.getElementById(`rating-${eventId}`).value;
  if (!rating) { alert('Select rating'); return; }

  await fetch(`${backendURL}/feedback`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ student_id: studentId, event_id: eventId, rating: parseInt(rating), comments: '' })
  });
  alert('Feedback submitted!');
}
</script>

</body>
</html>
